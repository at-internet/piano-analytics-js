((e,t)=>{"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("react-native"),require("@react-native-async-storage/async-storage")):"function"==typeof define&&define.amd?define(["exports","react-native","@react-native-async-storage/async-storage"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).pianoAnalytics={},e.reactNative,e.AsyncStorage)})(this,function(e,c,r){var l={site:"",collectDomain:"",path:"event",visitorStorageMode:"fixed",storageLifetimeVisitor:395,storageLifetimeUser:395,storageLifetimePrivacy:395,privacyDefaultMode:"optin",sendEventWhenOptout:!0,isVisitorClientSide:!0,enableCallbacks:!0,cookieDomain:"",cookieSecure:!0,cookiePath:"/",cookieSameSite:"lax",encodeStorageBase64:!1,addEventURL:"withoutQS",clickAutoManagement:!0,enableUTMTracking:!0,campaignPrefix:["at_"],storageVisitor:"pa_vid",storageUser:"pa_user",version:"6.16.2",minHeartbeat:5,minBufferingHeartbeat:1,queueVarName:"_paq",globalVarName:"pa",enableAutomaticPageRefresh:!0,allowHighEntropyClientHints:!0,sendEmptyProperties:!0,enableExtendedOptout:!1,instantTracking:!1,useSendBeacon:!0,privacy:{storageKey:"pa_privacy",legacyKeys:{pa_vid:!0,pa_privacy:!0,atuserid:!0},storageKeys:{pa_user:!0},modes:{optin:{name:"optin",properties:{include:{visitor_privacy_consent:!0,visitor_privacy_mode:"optin"},allowed:{"*":{"*":!0}},forbidden:{"*":{}}},storage:{allowed:{"*":!0},forbidden:{}},events:{allowed:{"*":!0},forbidden:{}}},optout:{name:"optout",visitorId:"OPT-OUT",properties:{include:{visitor_privacy_consent:!1,visitor_privacy_mode:"optout"},allowed:{"*":{}},forbidden:{"*":{}}},storage:{allowed:{pa_vid:!0,pa_privacy:!0},forbidden:{}},events:{allowed:{"*":!0},forbidden:{}}},"no-consent":{name:"no-consent",visitorId:"no-consent",properties:{include:{visitor_privacy_consent:!1,visitor_privacy_mode:"no-consent"},allowed:{"*":{}},forbidden:{"*":{}}},storage:{allowed:{},forbidden:{"*":!0}},events:{allowed:{"*":!0},forbidden:{}}},"no-storage":{name:"no-storage",visitorId:"no-storage",properties:{include:{visitor_privacy_consent:!1,visitor_privacy_mode:"no-storage"},allowed:{"*":{"*":!0}},forbidden:{"*":{}}},storage:{allowed:{},forbidden:{"*":!0}},events:{allowed:{"*":!0},forbidden:{}}},exempt:{name:"exempt",properties:{include:{visitor_privacy_consent:!1,visitor_privacy_mode:"exempt"},allowed:{"*":{app_crash:!0,app_crash_class:!0,app_crash_screen:!0,app_version:!0,browser:!0,browser_cookie_acceptance:!0,browser_group:!0,browser_version:!0,click:!0,click_chapter1:!0,click_chapter2:!0,click_chapter3:!0,click_full_name:!0,connection_monitor:!0,connection_organisation:!0,cookie_creation_date:!0,date:!0,date_day:!0,date_daynumber:!0,date_month:!0,date_monthnumber:!0,date_week:!0,date_year:!0,date_yearofweek:!0,device_brand:!0,device_display_height:!0,device_display_width:!0,device_name:!0,device_name_tech:!0,device_screen_diagonal:!0,device_screen_height:!0,device_screen_width:!0,device_type:!0,event_collection_platform:!0,event_collection_version:!0,event_hour:!0,event_id:!0,event_minute:!0,event_position:!0,event_second:!0,event_time:!0,event_time_utc:!0,event_url:!0,event_url_domain:!0,event_url_full:!0,exclusion_cause:!0,exclusion_type:!0,geo_city:!0,geo_continent:!0,geo_country:!0,geo_metro:!0,geo_region:!0,goal_type:!0,hit_time_utc:!0,os:!0,os_group:!0,os_version:!0,os_version_name:!0,page:!0,page_chapter1:!0,page_chapter2:!0,page_chapter3:!0,page_duration:!0,page_full_name:!0,page_position:!0,page_title_html:!0,page_url:!0,pageview_id:!0,previous_url:!0,privacy_status:!0,site:!0,site_env:!0,site_id:!0,site_platform:!0,src:!0,src_detail:!0,src_direct_access:!0,src_organic:!0,src_organic_detail:!0,src_portal_domain:!0,src_portal_site:!0,src_portal_site_id:!0,src_portal_url:!0,src_referrer_site_domain:!0,src_referrer_site_url:!0,src_referrer_url:!0,src_se:!0,src_se_category:!0,src_se_country:!0,src_type:!0,src_url:!0,src_url_domain:!0,src_webmail:!0}},forbidden:{"*":{}}},storage:{allowed:{pa_vid:!0,pa_privacy:!0,atuserid:!0},forbidden:{}},events:{allowed:{"click.exit":!0,"click.navigation":!0,"click.download":!0,"click.action":!0,"page.display":!0},forbidden:{}}},"*":{properties:{allowed:{"*":{connection_type:!0,device_timestamp_utc:!0,visitor_privacy_consent:!0,visitor_privacy_mode:!0,"ch_ua*":!0}},forbidden:{"*":{}}},storage:{allowed:{},forbidden:{}},events:{allowed:{},forbidden:{}}}}}};function n(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=Array(t);r<t;r++)n[r]=e[r];return n}function u(e,t,r,n,o,i,a){try{var s=e[i](a),u=s.value}catch(e){return r(e)}s.done?t(u):Promise.resolve(u).then(n,o)}function f(s){return function(){var e=this,a=arguments;return new Promise(function(t,r){var n=s.apply(e,a);function o(e){u(n,t,r,o,i,"next",e)}function i(e){u(n,t,r,o,i,"throw",e)}o(void 0)})}}function m(e,t){var r,n,o,i,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return o=!(n=!0),{s:function(){a=a.call(e)},n:function(){var e=a.next();return n=e.done,e},e:function(e){o=!0,r=e},f:function(){try{n||null==a.return||a.return()}finally{if(o)throw r}}};if(Array.isArray(e)||(a=s(e))||t)return a&&(e=a),i=0,{s:t=function(){},n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function p(){var v,e="function"==typeof Symbol?Symbol:{},t=e.iterator||"@@iterator",r=e.toStringTag||"@@toStringTag";function n(e,t,r,n){var o,i,a,s,u,c,l,f,p,t=t&&t.prototype instanceof y?t:y,t=Object.create(t.prototype);return _(t,"_invoke",(o=e,i=r,l=n||[],f=!1,p={p:c=0,n:0,v:v,a:d,f:d.bind(v,4),d:function(e,t){return a=e,s=0,u=v,p.n=t,g}},function(e,t,r){if(1<c)throw TypeError("Generator is already running");for(f&&1===t&&d(t,r),s=t,u=r;(h=s<2?v:u)||!f;){a||(s?s<3?(1<s&&(p.n=-1),d(s,u)):p.n=u:p.v=u);try{if(c=2,a){if(h=a[e=s?e:"next"]){if(!(h=h.call(a,u)))throw TypeError("iterator result is not an object");if(!h.done)return h;u=h.value,s<2&&(s=0)}else 1===s&&(h=a.return)&&h.call(a),s<2&&(u=TypeError("The iterator does not provide a '"+e+"' method"),s=1);a=v}else if((h=(f=p.n<0)?u:o.call(i,p))!==g)break}catch(e){a=v,s=1,u=e}finally{c=1}}return{value:h,done:f}}),!0),t;function d(e,t){for(s=e,u=t,h=0;!f&&c&&!r&&h<l.length;h++){var r,n=l[h],o=p.p,i=n[2];3<e?(r=i===t)&&(u=n[(s=n[4])?5:s=3],n[4]=n[5]=v):n[0]<=o&&((r=e<2&&o<n[1])?(s=0,p.v=t,p.n=n[1]):o<i&&(r=e<3||n[0]>t||i<t)&&(n[4]=e,n[5]=t,p.n=i,s=0))}if(r||1<e)return g;throw f=!0,t}}var g={};function y(){}function o(){}function i(){}var h=Object.getPrototypeOf,e=[][t]?h(h([][t]())):(_(h={},t,function(){return this}),h),a=i.prototype=y.prototype=Object.create(e);function s(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,i):(e.__proto__=i,_(e,r,"GeneratorFunction")),e.prototype=Object.create(a),e}return _(a,"constructor",o.prototype=i),_(i,"constructor",o),_(i,r,o.displayName="GeneratorFunction"),_(a),_(a,r,"Generator"),_(a,t,function(){return this}),_(a,"toString",function(){return"[object Generator]"}),(p=function(){return{w:n,m:s}})()}function _(e,t,r,n){var i=Object.defineProperty;try{i({},"",{})}catch(e){i=0}(_=function(e,t,r,n){function o(t,r){_(e,t,function(e){return this._invoke(t,r,e)})}t?i?i(e,t,{value:r,enumerable:!n,configurable:!n,writable:!n}):e[t]=r:(o("next",0),o("throw",1),o("return",2))})(e,t,r,n)}function d(e){return(e=>{if(Array.isArray(e))return n(e)})(e)||(e=>{if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)})(e)||s(e)||(()=>{throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")})()}function o(e){return(o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function s(e,t){var r;if(e)return"string"==typeof e?n(e,t):"Map"===(r="Object"===(r={}.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(e,t):void 0}var i,E=function(e,t){if("object"!==o(e)||null===e||e instanceof Date)return e;var r,n=new e.constructor;for(r in e)Object.prototype.hasOwnProperty.call(e,r)&&void 0!==r&&(n[r]=E(e[r]));return n},a="piano_analytics_pending_events",v=null,g=null,y=(()=>{var e=f(p().m(function e(){return p().w(function(e){for(;;)switch(e.n){case 0:if(null!==v)return e.a(2,v);e.n=1;break;case 1:if(g)return e.a(2,g);e.n=2;break;case 2:return g=f(p().m(function e(){var t;return p().w(function(e){for(;;)switch(e.n){case 0:return e.p=0,e.n=1,r.getItem(a);case 1:return t=e.v,v=t?JSON.parse(t):[],e.a(2,v);case 2:return e.p=2,t=e.v,console.error("Failed to get stored pending events:",t),v=[],e.a(2,v);case 3:return e.p=3,g=null,e.f(3);case 4:return e.a(2)}},e,null,[[0,2,3,4]])}))(),e.a(2,g)}},e)}));return function(){return e.apply(this,arguments)}})(),h=(()=>{var e=f(p().m(function e(){var t;return p().w(function(e){for(;;)switch(e.n){case 0:return e.p=0,e.n=1,r.setItem(a,JSON.stringify(v));case 1:e.n=3;break;case 2:e.p=2,t=e.v,console.error("Failed to persist pending events:",t);case 3:return e.a(2)}},e,null,[[0,2]])}));return function(){return e.apply(this,arguments)}})(),b=(y().then(function(e){0<e.length&&__DEV__&&console.log("Loaded ".concat(e.length," pending events from storage"))}).catch(function(e){console.error("Error loading pending events at startup:",e)}),(()=>{var t=f(p().m(function e(n){return p().w(function(e){for(;;)switch(e.n){case 0:if(Array.isArray(n)&&0<n.length){if(n.forEach(function(e){null!=e&&e.data&&(e.data.connection_type="OFFLINE")}),!v)return e.n=1,y();e.n=1}else e.n=2;break;case 1:return t=n,r=void 0,r=[].concat(d(v),d(t)),v=r.slice(Math.max(0,r.length-100)),__DEV__&&console.log("Added ".concat(t.length," events to pending events cache, total now: ").concat(v.length)),e.n=2,h();case 2:return e.a(2)}var t,r},e)}));return function(e){return t.apply(this,arguments)}})()),P={post:(i=f(p().m(function e(t,r,n,o){var i,a,s,u;return p().w(function(e){for(;;)switch(e.n){case 0:if(i=n,a=null,e.p=1,0<(null==(u=v)?void 0:u.length))return __DEV__&&console.log("Found ".concat(v.length," pending events to merge")),__DEV__&&console.log("Pending events:",v),i={events:[].concat(d(v),d(n.events))},__DEV__&&console.log("Merged ".concat(v.length," previous events with current request")),v=[],e.n=2,h();e.n=2;break;case 2:__DEV__&&console.log("Data to send:",i),__DEV__&&console.log("Sending to URL:",r),a=JSON.stringify(i),e.n=4;break;case 3:e.p=3,u=e.v,console.error("Error creating post body:",u);case 4:if(a){e.n=5;break}return e.a(2,Promise.reject(new Error("Cannot create post body")));case 5:return s={method:"POST",headers:{"Content-Type":"text/plain;charset=UTF-8"},body:a},"android"===c.Platform.OS&&(s.headers["User-Agent"]="PA SDK React Native Android/".concat(l.version)),e.a(2,fetch(r,s).then(function(e){if(!e.ok)throw new Error("HTTP error! status: ".concat(e.status));__DEV__&&console.log("Success tracking event"),o&&o(r,e)}).catch((()=>{var t=f(p().m(function e(t){return p().w(function(e){for(;;)switch(e.n){case 0:__DEV__&&console.log("Request failed, storing events as pending:",t),b(i.events);case 1:return e.a(2)}},e)}));return function(e){return t.apply(this,arguments)}})()))}},e,null,[[1,3]])})),function(e,t,r,n){return i.apply(this,arguments)})},C="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",w={utf8:{encode:function(e){e=e.replace(/\r\n/g,"\n");for(var t="",r=0;r<e.length;r++){var n=e.charCodeAt(r);n<128?t+=String.fromCharCode(n):t=127<n&&n<2048?(t+=String.fromCharCode(n>>6|192))+String.fromCharCode(63&n|128):(t=(t+=String.fromCharCode(n>>12|224))+String.fromCharCode(n>>6&63|128))+String.fromCharCode(63&n|128)}return t},decode:function(e){var t,r,n,o="",i=0;for(t=0;i<e.length;)(n=e.charCodeAt(i))<128?(o+=String.fromCharCode(n),i++):191<n&&n<224?(t=e.charCodeAt(i+1),o+=String.fromCharCode((31&n)<<6|63&t),i+=2):(t=e.charCodeAt(i+1),r=e.charCodeAt(i+2),o+=String.fromCharCode((15&n)<<12|(63&t)<<6|63&r),i+=3);return o}},base64:{encode:function(e){var t,r,n,o,i,a,s="",u=0;for(e=w.utf8.encode(e);u<e.length;)n=(t=e.charCodeAt(u++))>>2,o=(3&t)<<4|(t=e.charCodeAt(u++))>>4,i=(15&t)<<2|(r=e.charCodeAt(u++))>>6,a=63&r,isNaN(t)?i=a=64:isNaN(r)&&(a=64),s=s+C.charAt(n)+C.charAt(o)+C.charAt(i)+C.charAt(a);return s},decode:function(e){var t,r,n,o,i,a,s="",u=0;for(e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");u<e.length;)n=C.indexOf(e.charAt(u++)),t=(15&(o=C.indexOf(e.charAt(u++))))<<4|(i=C.indexOf(e.charAt(u++)))>>2,r=(3&i)<<6|(a=C.indexOf(e.charAt(u++))),s+=String.fromCharCode(n<<2|o>>4),64!=i&&(s+=String.fromCharCode(t)),64!=a&&(s+=String.fromCharCode(r));return s=w.utf8.decode(s)}}},I={v4:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}};function k(e){var r=e;function n(e,t){null!==t&&""!==t&&void 0!==t&&(r[e]=t)}return{setConfiguration:n,setConfigurations:function(e){for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&n(t,e[t])},getConfiguration:function(e){return void 0!==r[e]?E(r[e]):null},cloneData:function(){return E(r)},deleteProperty:function(e){delete r[e]}}}function O(t){var r=[];return{push:function(e){r.push(e),1===r.length&&t[e[0]].apply(t,e.slice(1))},next:function(){var e;r.shift(),0<r.length&&t[(e=r[0])[0]].apply(t,e.slice(1))}}}function T(i,e,t){this.properties=E(i._properties),this.addEventsProperty=function(e,t){if(i._privacy.call("isPropAllowed",e)){var r,n=m(this.events);try{for(n.s();!(r=n.n()).done;){var o=r.value;this.isPropertyAbsentForEvent(e,o)&&(o.data[e]=t)}}catch(e){n.e(e)}finally{n.f()}}},this.hasProperty=function(e){return Object.prototype.hasOwnProperty.call(this.properties,e)},this.getConfiguration=t.getConfiguration,this.setConfiguration=t.setConfiguration,this.options=e.options||{},this.visitorId=null,this.build={url:"",data:{}},this.events=e.events||[],this.isPropertyAbsentForEvent=function(e,t){if(void 0!==t.data[e])return!1;if(this.hasProperty(e)){if(void 0===this.properties[e].options.events)return!1;var r,n=m(this.properties[e].options.events);try{for(n.s();!(r=n.n()).done;){var o=r.value;if(t.name===o||"*"===o.charAt(o.length-1)&&0===t.name.indexOf(o.substring(0,o.length-1)))return!1}}catch(e){n.e(e)}finally{n.f()}}return!0}}function x(e,t,r,n){!1!==n&&0<r.length&&"function"==typeof r[0]?r[0](e,t,r.slice(1)):e._queue.next()}function S(e,t,r){var n=t.getConfiguration("collectDomain"),o=n.startsWith("https://")||n.startsWith("http://")?"":"https://",o="".concat(o).concat(n,"/").concat(t.getConfiguration("path")),n="?s=".concat(t.getConfiguration("site")).concat(t.visitorId?"&idclient="+t.visitorId:"");t.build.url=o+n,t.build.data={events:t.events},x(e,t,r)}function A(e,t,r){x(e,t,r)}function D(e,t,r){t.addEventsProperty("event_collection_platform","js-browserless"),t.addEventsProperty("event_collection_version",t.getConfiguration("version"));var n=new Date;t.addEventsProperty("device_timestamp_utc",n.getTime()/1e3),t.addEventsProperty("device_local_hour",n.getTime()),t.addEventsProperty("device_hour",n.getHours()),x(e,t,r)}function B(t,r,n){function e(e){x(t,r,n,e)}r.options&&r.options.onBeforeBuild?r.options.onBeforeBuild(t,r,e):e()}function H(t,r,n){function e(e){x(t,r,n,e)}r.options&&r.options.onBeforeSend?r.options.onBeforeSend(t,r,e):e()}function j(e,t,r){e._privacy.call("filterEvents",t.events),e._privacy.call("filterProps",t.properties);for(var n=t.events,o=0;o<n.length;o++){e._privacy.call("filterProps",n[o].data,n[o].name);var i,a=e._privacy.call("getModeMetadata")||{};for(i in a)Object.prototype.hasOwnProperty.call(a,i)&&t.addEventsProperty(i,a[i])}x(e,t,r)}function M(e,t,r){var n,o=[];for(n in t.properties)if(Object.prototype.hasOwnProperty.call(t.properties,n)){var i,a=!1,s=m(t.events);try{for(s.s();!(i=s.n()).done;){var u=i.value,c=!1,l=t.properties[n].options.events;if(l)if(-1<l.indexOf(u.name))c=!0;else{var f,p=m(l);try{for(p.s();!(f=p.n()).done;){var d=f.value;if("*"===d.charAt(d.length-1)&&0===u.name.indexOf(d.substring(0,d.length-1))){c=!0;break}}}catch(e){p.e(e)}finally{p.f()}}else c=!0;c&&void 0===u.data[n]&&(u.data[n]=t.properties[n].value,a=!0)}}catch(e){s.e(e)}finally{s.f()}a&&!t.properties[n].options.persistent&&o.push(n)}for(var v=0,g=o;v<g.length;v++)delete e._properties[g[v]];if(!t.getConfiguration("sendEmptyProperties")){var y,h=m(t.events);try{for(h.s();!(y=h.n()).done;){var _,b=y.value;for(_ in b.data)!Object.prototype.hasOwnProperty.call(b.data,_)||""!==b.data[_]&&void 0!==b.data[_]||delete b.data[_]}}catch(e){h.e(e)}finally{h.f()}}x(e,t,r)}function V(e,t,r){(e._privacy.call("getMode")!==e._privacy.getOptoutValue()||e._privacy.call("getMode")===e._privacy.getOptoutValue()&&t.getConfiguration("sendEventWhenOptout"))&&0<t.build.data.events.length&&P.post(t,t.build.url,t.build.data),x(e,t,r)}function K(r,n,o){void 0!==n.properties.user_id?x(r,n,o):r.getUser(function(e){var t;null!==e&&(n.addEventsProperty("user_id",e.id,t={persistent:!0}),n.addEventsProperty("user_category",e.category,t),n.addEventsProperty("user_recognition",!0,t)),x(r,n,o)})}function L(r,n,o){r._storage.getItem(n.getConfiguration("storageVisitor"),function(e){var t;!n.getConfiguration("isVisitorClientSide")||(n.visitorId=r._visitorId.value||e||I.v4(),t="OPT-OUT"!==n.visitorId&&"no-consent"!==n.visitorId&&"no-storage"!==n.visitorId&&n.visitorId!==r._visitorId.value,n.visitorId===e&&"relative"!==n.getConfiguration("visitorStorageMode"))||!t?x(r,n,o):((e=new Date).setTime(e.getTime()+24*n.getConfiguration("storageLifetimeVisitor")*60*60*1e3),r._privacy.call("setItem",n.getConfiguration("storageVisitor"),n.visitorId,e,function(){r._storage.getItem(n.getConfiguration("storageVisitor"),function(e){null===e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(n.visitorId)&&(n.visitorId=n.visitorId+"-NO"),x(r,n,o)})}))})}var N={};var U=function(o){this.setItem=function(e,t,r,n){t=JSON.stringify({data:t,expires:r?r.getTime():0});N[e]=o.getConfiguration("encodeStorageBase64")?w.base64.encode(t):t,n&&n()},this.getItem=function(t,e){var r,n=null;if(void 0!==N[t]){try{r=JSON.parse(N[t])}catch(e){r=JSON.parse(w.base64.decode(N[t]))}0===r.expires||(new Date).getTime()<r.expires?(n=r.data,e&&e(n)):(new Date).getTime()>r.expires&&this.deleteItem(t,function(){e&&e(n)})}else e&&e(n)},this.deleteItem=function(e,t){delete N[e],t&&t()}};function q(o){var i=o.getConfiguration("storageUser");o.setUser=function(e,t,r){var n={id:e,category:t};o.setProperties({user_id:e,user_category:t,user_recognition:!1},{persistent:!0}),!1!==r&&((e=new Date).setTime(e.getTime()+24*o.getConfiguration("storageLifetimeUser")*60*60*1e3),o._privacy.call("setItem",i,n,e))},o.getUser=function(r){o._storage.getItem(i,function(e){var t=e;!e&&o._properties.user_id&&(t={id:o._properties.user_id.value,category:o._properties.user_category.value}),r&&r(t)})},o.deleteUser=function(e){o.deleteProperty("user_id"),o.deleteProperty("user_category"),o.deleteProperty("user_recognition"),o._storage.deleteItem(i,function(){e&&e()})}}function F(C){function w(){this.debugError={trigger:"AvInsights:Media:setContentValues:Error",level:"ERROR",messageObject:"Not an object"},this.processHeartbeatValue=function(e,t){e=parseInt(e,10);return e?Math.max(e,t):0},this.value2Number=function(e){var t=0;return isNaN(Number(e))||(t=Number(e)),Math.max(t,0)}}var k={minHeartbeat:C.getConfiguration("minHeartbeat"),minBufferingHeartbeat:C.getConfiguration("minBufferingHeartbeat")},O="_ATVALUE",T="_ATPREFIX";function x(e){var e=e.length<2||":"!==e[1]?(t="",e):e.length<4||":"!==e[3]?(t=e.substring(0,1),e.substring(2,e.length)):(t=e.substring(0,3),e.substring(4,e.length)),t=t.toLowerCase();return{prefix:t,key:e=e.toLowerCase()}}function S(e){return null!==e&&"object"===o(e)&&!(e instanceof Array)}function A(e,t,r,n){var o,i,a,s="",u="",c="",l=0;for(a in e)if(Object.prototype.hasOwnProperty.call(e,a))if(s=(o=x(a)).prefix||n||"",u=(t?t+"_":"")+o.key,S(e[a]))A(e[a],u,r,s);else{for(i=u.split("_"),c="",l=0;l<i.length;l++)s=(o=x(i[l])).prefix||s,c+=o.key+(l<i.length-1?"_":"");r[u=c||u]=r[u]||{},r[u][O]=e[a],r[u][T]=s}}C.avInsights={},C.avInsights.Media=function(e,t,r){function n(){d.previousCursorPosition=0,d.currentCursorPosition=0,d.eventDuration=0,d.previousEvent="",d.sessionId=I.v4()}function o(e){e?d.delayBufferingConfiguration=E(d.delayBufferingConfigurationBackup):d.delayConfiguration=E(d.delayConfigurationBackup)}function i(e,t){if(t){h(e);var r,n={};for(r in S(t)?n=t:isNaN(t)?n=JSON.parse(t):n[0]=t,n)Object.prototype.hasOwnProperty.call(n,r)&&(e?d.delayBufferingConfiguration.push({delay:p.processHeartbeatValue(r,0),number:0,timeout:-1,refresh:p.processHeartbeatValue(n[r],k.minBufferingHeartbeat)}):d.delayConfiguration.push({delay:p.processHeartbeatValue(r,0),number:0,timeout:-1,refresh:p.processHeartbeatValue(n[r],k.minHeartbeat)}));_(e),y(e)}}function a(e,t,r,n){var o=E(g),t=(o.av_session_id={},o.av_session_id[O]=d.sessionId,o.av_session_id[T]="",t&&(m(o),d.previousEvent=e),S(n)&&A(n,null,o,null),P(o));C.sendEvent(e,t,r)}function s(){var e=this,t=0,r=0;e.getEventDuration=function(){var e=(new Date).getTime()-t-r;return r+=e,e},e.initBaseTime=function(){0===t&&(t=(new Date).getTime())},e.resetProperties=function(){r=t=0},e.initHeartbeatTimer=function(e,t){var r=t?d.delayBufferingConfiguration:d.delayConfiguration;0<r.length&&(b(t),clearTimeout(r[0].timeout),r[0].timeout=setTimeout(function(){0===r[0].number&&r.splice(0,1),e&&e()},1e3*r[0].refresh))},e.stopHeartbeatTimer=function(e){for(var t=e?d.delayBufferingConfiguration:d.delayConfiguration,r=0;r<t.length;r++)clearTimeout(t[r].timeout),t[r].timeout=-1}}function u(e,t,r,n,o){v.initBaseTime(),d.eventDuration=v.getEventDuration(),d.previousCursorPosition=d.currentCursorPosition,d.currentCursorPosition=e?d.previousCursorPosition+Math.floor(d.playbackSpeed*d.eventDuration):r,t&&v.initHeartbeatTimer(function(){u(!0,!0)},!1),a("av.heartbeat",!0,n,o)}function c(e,t,r){v.initBaseTime(),d.eventDuration=v.getEventDuration(),e&&v.initHeartbeatTimer(function(){c(!0)},!0),a("av.buffer.heartbeat",!0,t,r)}function l(e,t,r){v.initBaseTime(),d.eventDuration=v.getEventDuration(),d.previousCursorPosition=d.currentCursorPosition,e&&v.initHeartbeatTimer(function(){l(!0)},!0),a("av.rebuffer.heartbeat",!0,t,r)}var f=this,p=new w,d=null,v=null,g=null,y=function(e){e?d.delayBufferingConfigurationBackup=E(d.delayBufferingConfiguration):d.delayConfigurationBackup=E(d.delayConfiguration)},h=function(e){e?(d.delayBufferingConfiguration=[],d.delayBufferingConfigurationBackup=[]):(d.delayConfiguration=[],d.delayConfigurationBackup=[])},_=function(e){(e?d.delayBufferingConfiguration:d.delayConfiguration).sort(function(e,t){return e.delay<t.delay?-1:t.delay<e.delay?1:0})},b=function(e){var t,e=e?d.delayBufferingConfiguration:d.delayConfiguration;void 0===(t=void 0!==e[1]?e[1].delay:t)?e[0].number=1:0<e[0].number?e[0].number--:"number"==typeof t&&(e[0].number=Math.floor(60*(t-e[0].delay)/e[0].refresh)-1)},m=function(e){e.av_previous_position={},e.av_previous_position[O]=d.previousCursorPosition,e.av_previous_position[T]="",e.av_position={},e.av_position[O]=d.currentCursorPosition,e.av_position[T]="",e.av_duration={},e.av_duration[O]=d.eventDuration,e.av_duration[T]="",e.av_previous_event={},e.av_previous_event[O]=d.previousEvent,e.av_previous_event[T]=""},P=function(e){var t,r={};for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(Object.prototype.hasOwnProperty.call(e[t],O)?r[e[t][T]?"".concat(e[t][T],":").concat(t):t]=e[t][O]:r[t]=e[t]);return r};f.set=function(e,t){e=x(e);g[e.key]=g[e.key]||{},g[e.key][O]=t,g[e.key][T]=e.prefix},f.get=function(e){var t=null,e=x(e);return t=void 0!==g[e.key]?g[e.key][O]:t},f.del=function(e){e=x(e);void 0!==g[e.key]&&delete g[e.key]},f.setProps=function(e){S(e)&&A(e,null,g,null)},f.getProps=function(){var e,t=null;for(e in g)Object.prototype.hasOwnProperty.call(g,e)&&((t=t||{})[e]=g[e][O]);return t},f.delProps=function(){g={}};f.setPlaybackSpeed=function(e){e=p.value2Number(e)||d.playbackSpeed;e!==d.playbackSpeed&&(v.stopHeartbeatTimer(!1),d.isPlaying&&(u(!0,!1),v.initHeartbeatTimer(function(){u(!0,!0)},!1)),d.playbackSpeed=e)},f.getSessionID=function(){return d.sessionId},f.track=function(e,t,r,n){var o=t||{};switch(e){case"av.heartbeat":f.heartbeat(o.av_position,r,n);break;case"av.buffer.heartbeat":f.bufferHeartbeat(r,n);break;case"av.rebuffer.heartbeat":f.rebufferHeartbeat(r,n);break;case"av.play":f.play(o.av_position,r,n);break;case"av.buffer.start":f.bufferStart(o.av_position,r,n);break;case"av.start":f.playbackStart(o.av_position,r,n);break;case"av.resume":f.playbackResumed(o.av_position,r,n);break;case"av.pause":f.playbackPaused(o.av_position,r,n);break;case"av.stop":f.playbackStopped(o.av_position,r,n);break;case"av.backward":f.seekBackward(o.av_previous_position,o.av_position,r,n);break;case"av.forward":f.seekForward(o.av_previous_position,o.av_position,r,n);break;case"av.seek.start":f.seekStart(o.av_previous_position,r,n);break;case"av.error":f.error(o.av_player_error,r,n);break;default:a(e,!1,r,n)}},f.heartbeat=function(e,t,r){var n,o=!0;null!=e&&0<=e&&(o=!1,n=p.value2Number(e)),u(o,!1,n,t,r)},f.bufferHeartbeat=function(e,t){c(!1,e,t)},f.rebufferHeartbeat=function(e,t){l(!1,e,t)},f.play=function(e,t,r){v.initBaseTime();e=p.value2Number(e);d.eventDuration=0,d.previousCursorPosition=e,d.currentCursorPosition=e,d.isPlaying=!1,d.isPlaybackActivated=!1,v.stopHeartbeatTimer(!1),v.stopHeartbeatTimer(!0),a("av.play",!0,t,r)},f.bufferStart=function(e,t,r){v.initBaseTime();e=p.value2Number(e);d.eventDuration=v.getEventDuration(),d.previousCursorPosition=d.currentCursorPosition,d.currentCursorPosition=e,v.stopHeartbeatTimer(!1),v.stopHeartbeatTimer(!0),d.isPlaybackActivated?(v.initHeartbeatTimer(function(){l(!0)},!0),a("av.rebuffer.start",!0,t,r)):(v.initHeartbeatTimer(function(){c(!0)},!0),a("av.buffer.start",!0,t,r))},f.playbackStart=function(e,t,r){v.initBaseTime();e=p.value2Number(e);d.eventDuration=v.getEventDuration(),d.previousCursorPosition=e,d.currentCursorPosition=e,d.isPlaying=!0,d.isPlaybackActivated=!0,v.stopHeartbeatTimer(!1),v.stopHeartbeatTimer(!0),v.initHeartbeatTimer(function(){u(!0,!0)},!1),a("av.start",!0,t,r)},f.playbackResumed=function(e,t,r){v.initBaseTime();e=p.value2Number(e);d.eventDuration=v.getEventDuration(),d.previousCursorPosition=d.currentCursorPosition,d.currentCursorPosition=e,d.isPlaying=!0,d.isPlaybackActivated=!0,v.stopHeartbeatTimer(!1),v.stopHeartbeatTimer(!0),v.initHeartbeatTimer(function(){u(!0,!0)},!1),a("av.resume",!0,t,r)},f.playbackPaused=function(e,t,r){v.initBaseTime();e=p.value2Number(e);d.eventDuration=v.getEventDuration(),d.previousCursorPosition=d.currentCursorPosition,d.currentCursorPosition=e,d.isPlaying=!1,d.isPlaybackActivated=!0,v.stopHeartbeatTimer(!1),v.stopHeartbeatTimer(!0),a("av.pause",!0,t,r)},f.playbackStopped=function(e,t,r){v.initBaseTime();e=p.value2Number(e);d.eventDuration=v.getEventDuration(),d.previousCursorPosition=d.currentCursorPosition,d.currentCursorPosition=e,d.isPlaying=!1,d.isPlaybackActivated=!1,v.stopHeartbeatTimer(!1),v.stopHeartbeatTimer(!0),v.resetProperties(),o(!1),o(!0),a("av.stop",!0,t,r),n()},f.playbackKill=function(){v.initBaseTime(),d.isPlaying=!1,d.isPlaybackActivated=!1,v.stopHeartbeatTimer(!1),v.stopHeartbeatTimer(!0),v.resetProperties(),o(!1),o(!0),n()},f.seek=function(e,t,r,n){e=p.value2Number(e),t=p.value2Number(t);t<e?f.seekBackward(e,t,r,n):f.seekForward(e,t,r,n)},f.seekBackward=function(e,t,r,n){f.seekStart(e,null,n),d.eventDuration=0,d.previousCursorPosition=p.value2Number(e),d.currentCursorPosition=p.value2Number(t),a("av.backward",!0,r,n)},f.seekForward=function(e,t,r,n){f.seekStart(e,null,n),d.eventDuration=0,d.previousCursorPosition=p.value2Number(e),d.currentCursorPosition=p.value2Number(t),a("av.forward",!0,r,n)},f.seekStart=function(e,t,r){e=p.value2Number(e);d.previousCursorPosition=d.currentCursorPosition,d.currentCursorPosition=e,d.isPlaying?d.eventDuration=v.getEventDuration():d.eventDuration=0,a("av.seek.start",!0,t,r)},f.adClick=function(e,t){a("av.ad.click",!1,e,t)},f.adSkip=function(e,t){a("av.ad.skip",!1,e,t)},f.error=function(e,t,r){var n={};(n=S(r)?r:n).av_player_error=String(e),a("av.error",!1,t,n)},f.display=function(e,t){a("av.display",!1,e,t)},f.close=function(e,t){a("av.close",!1,e,t)},f.volume=function(e,t){a("av.volume",!1,e,t)},f.subtitleOn=function(e,t){a("av.subtitle.on",!1,e,t)},f.subtitleOff=function(e,t){a("av.subtitle.off",!1,e,t)},f.fullscreenOn=function(e,t){a("av.fullscreen.on",!1,e,t)},f.fullscreenOff=function(e,t){a("av.fullscreen.off",!1,e,t)},f.quality=function(e,t){a("av.quality",!1,e,t)},f.speed=function(e,t){a("av.speed",!1,e,t)},i(!(d={previousCursorPosition:0,currentCursorPosition:0,eventDuration:0,playbackSpeed:1,previousEvent:"",isPlaybackActivated:!(f.share=function(e,t){a("av.share",!1,e,t)}),isPlaying:!1,sessionId:"",delayConfiguration:[],delayConfigurationBackup:[],delayBufferingConfiguration:[],delayBufferingConfigurationBackup:[]}),e),i(!0,t),d.sessionId=r||I.v4(),v=new s,g={}}}function R(o){this.value=null,o.getVisitorId=function(t){var r=this.value,n=null;if(o._storage.getItem(o.getConfiguration("storageVisitor"),function(e){n=((e,t)=>(t&&t(e),e))(r||e,t)}.bind(o)),void 0===t)return n}.bind(this),o.setVisitorId=function(e){this.value=e;var t=new Date;t.setTime(t.getTime()+24*o.getConfiguration("storageLifetimeVisitor")*60*60*1e3),o._privacy.call("setItem",o.getConfiguration("storageVisitor"),e,t,function(){})}.bind(this)}function J(o){function r(e,t,r,n){return r=u(t[r].events[e],n),t=u(t["*"].events[e],n),r||t}function n(e,t,r,n,o){var i,o=o?(i=c(t[r].properties,e,n,o),c(t["*"].properties,e,n,o)):(i=l(t[r].properties,e,n),l(t["*"].properties,e,n));return i||o}function i(e,t,r,n){return r=f(t[r].storage,e,n),t=f(t["*"].storage,e,n),r||t}var a=o.getConfiguration("privacy"),s=(this.currentMode="",this.modes=a.modes,this._storageKeys=Object.assign(a.legacyKeys,a.storageKeys),this.init=function(){o._privacy.isLegacyPrivacy&&o._storage.getItem(a.storageKey,function(e){this.setMode(e&&this.modes[e]?e:o.getConfiguration("privacyDefaultMode"))}.bind(this))},this.setMode=function(t){t!==this.currentMode&&this.modes[t]&&(this.currentMode=t,o._storage.getItem(a.storageKey,function(e){"optout"===t||"no-consent"===t||"no-storage"===t?o._visitorId.value=this.modes[t].visitorId:"OPT-OUT"!==o._visitorId.value&&"no-consent"!==o._visitorId.value&&"no-storage"!==o._visitorId.value||(o._visitorId.value=null),this.filterProps(o._properties),this.filterKeys(),e!==t&&((e=new Date).setTime(e.getTime()+24*o.getConfiguration("storageLifetimePrivacy")*60*60*1e3),this.setItem(a.storageKey,t,e))}.bind(this)))},this.createMode=function(e,t){var r;this.modes[e]||((r=E(this.modes.exempt)).name=e,r.properties.include.visitor_privacy_mode=e,r.properties.include.visitor_privacy_consent=t,this.modes[e]=r)},this.getMode=function(){return this.currentMode},function(e,t,r,n,o,i){var a=["*"],s=["*"],u="properties",c=n?"forbidden":"allowed";t&&(a="string"==typeof t?[t]:t),r&&(s="string"==typeof r?[r]:r),o&&(u="storage"),i&&(u="events");for(var l=0;l<a.length;l++)if(void 0!==this.modes[a[l]])for(var f=this.modes[a[l]],p=0;p<s.length;p++){var d=f[u][c];void 0!==d[s[p]]||o||i||(d[s[p]]={});for(var v=0;v<e.length;v++)o||i?d[e[v]]=!0:d[s[p]][e[v]]=!0}}.bind(this)),u=(this.include={properties:function(e,t,r){s(e,t,r)},property:function(e,t,r){s([e],t,r)},storageKeys:function(e,t){s(e,t,null,!1,!0)},storageKey:function(e,t){s([e],t,null,!1,!0)},events:function(e,t){s(e,t,null,!1,!1,!0)},event:function(e,t){s([e],t,null,!1,!1,!0)}},this.exclude={properties:function(e,t,r){s(e,t,r,!0)},property:function(e,t,r){s([e],t,r,!0)},storageKeys:function(e,t){s(e,t,null,!0,!0)},storageKey:function(e,t){s([e],t,null,!0,!0)},events:function(e,t){s(e,t,null,!0,!1,!0)},event:function(e,t){s([e],t,null,!0,!1,!0)}},function(e,t){if(e[t])return!0;for(var r in e)if(Object.prototype.hasOwnProperty.call(e,r)&&"*"===r.charAt(r.length-1)&&0===t.indexOf(r.substring(0,r.length-1)))return!0;return!1}),c=(this.isEventAllowed=function(e){var t=r("forbidden",this.modes,this.currentMode,e),e=r("allowed",this.modes,this.currentMode,e);return!t&&e},function(e,t,r,n){var o,i=e[t];if(i[n]&&i[n][r]||i["*"][r])return!0;for(o in i)if(Object.prototype.hasOwnProperty.call(i,o)&&"*"===o.charAt(o.length-1)&&0===n.indexOf(o.substring(0,o.length-1))||o===n)for(var a in i[o])if(Object.prototype.hasOwnProperty.call(i[o],a)&&("*"===a.charAt(a.length-1)&&0===r.indexOf(a.substring(0,a.length-1))||r===a))return!0;return!1}),l=function(e,t,r){if("forbidden"===t&&e[t]["*"][r])return!0;for(var n in e[t])if(Object.prototype.hasOwnProperty.call(e[t],n)){if(e[t][n][r])return!0;for(var o in e[t][n])if("*"===o.charAt(o.length-1)&&0===r.indexOf(o.substring(0,o.length-1)))return!0}return!1},f=(this.isPropAllowed=function(e,t){var r=n("forbidden",this.modes,this.currentMode,e,t),e=n("allowed",this.modes,this.currentMode,e,t);return!r&&e},function(e,t,r){var n,o=e[t];if(o[r])return!0;for(n in o)if(Object.prototype.hasOwnProperty.call(o,n)&&"*"===n.charAt(n.length-1)&&0===r.indexOf(n.substring(0,n.length-1)))return!0;return!1});this.isKeyAllowed=function(e){var t=i("forbidden",this.modes,this.currentMode,e),e=i("allowed",this.modes,this.currentMode,e);return!t&&e},this.setItem=function(e,t,r,n){this.isKeyAllowed(e)?o._storage.setItem(e,t,r,n):n&&n()},this.filterProps=function(e,t){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&!this.isPropAllowed(r,t||void 0)&&delete e[r]},this.filterKeys=function(){for(var e in this._storageKeys)Object.prototype.hasOwnProperty.call(this._storageKeys,e)&&!this.isKeyAllowed(e)&&o._storage.deleteItem(e)},this.filterEvents=function(e){for(var t=e.length-1;0<=t;t--)this.isEventAllowed(e[t].name)||e.splice(t,1)},this.getModeMetadata=function(){return this.modes[this.getMode()].properties.include},this.init()}function G(i){this.isLegacyPrivacy=!0,this.getOptoutValue=function(){return this.isLegacyPrivacy?"optout":"opt-out"},this.call=function(e){for(var t=this.isLegacyPrivacy?"privacy":"consent",r=arguments.length,n=new Array(1<r?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];return i[t][e].apply(i[t],n)}}function t(e){var t;(t=this).cfg=new k(E(e)||l),t.setConfiguration=t.cfg.setConfiguration,t.setConfigurations=t.cfg.setConfigurations,t.getConfiguration=t.cfg.getConfiguration,this._storage=new U(this),this._queue=new O(this),this._properties={},this._sendEvent=W,this._setProperty=z,this._deleteProperty=Q,this._visitorId=new R(this),(e=this)._privacy=new G(e),e.privacy=new J(e),this.user=new q(this),F(this)}function W(e,t){for(var r=[j,L,K,A,D,M,B,S,H,V],n=0;n<e.length;n++){var o={name:"",data:{}};if("string"==typeof e[n])o.name=e[n];else{if(void 0!==e[n].data)continue;o.name=e[n].name}e[n]=o}var i,t={events:E(e),options:E(t)};0<r.length&&"function"==typeof r[0]&&(i=new k(this.cfg.cloneData()),r[0](this,new T(this,t,i),r.slice(1)))}function z(e,t,r,n){e._privacy.call("isPropAllowed",t)&&(e._properties[t]={value:r,options:n||{}}),e._queue.next()}function Q(e,t){delete e._properties[t],e._queue.next()}t.prototype.setProperty=function(e,t,r){this._queue.push(["_setProperty",this,e,t,r])},t.prototype.setProperties=function(e,t){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&this.setProperty(r,e[r],t)},t.prototype.deleteProperty=function(e){this._queue.push(["_deleteProperty",this,e])},t.prototype.sendEvent=function(e,t,r){this._queue.push(["_sendEvent",[{name:e,data:t}],r])},t.prototype.sendEvents=function(e,t){this._queue.push(["_sendEvent",e,t])};var X=new(t.prototype.PA=t)(l);e.pianoAnalytics=X});
